name: Build, Test and Run App
on: push

jobs:
  build:
    name: Build, test and run using docker-compose
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Start database container
        run: |
          docker compose up -d db

      - name: Wait for database to be healthy
        run: |
          for i in {1..30}; do
            status=$(docker inspect --format='{{json .State.Health.Status}}' sem_db || echo '"starting"')
            echo "DB health status: $status"
            if [ "$status" = "\"healthy\"" ]; then
              echo "Database is healthy!"
              break
            fi
            sleep 5
          done

      - name: Run unit and integration tests
        run: mvn -B test

      - name: Package and run docker compose
        run: |
          mvn -B package -DskipTests
          docker compose up --build --abort-on-container-exit --exit-code-from app

      - name: Show app logs
        if: always()
        run: docker compose logs app

      - name: Tear down
        if: always()
        run: docker compose down -v
